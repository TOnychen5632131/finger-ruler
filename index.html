<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no, email=no, address=no">
  <title>指甲宽度测量 · mm（移动端·Safari优化）</title>
  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12151a;
      --ink:#eaeef5;
      --muted:#93a0b3;
      --accent:#4aa3ff;
      --accent-2:#ff5a7a;
      --ok:#19c37d;
      --warn:#ffb020;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 70% -10%, #1c2330, #0b0d10 52%);
      overflow: hidden;
      -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
      touch-action: none;
    }
    #gate{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center;
      padding:24px; color:#cbd5e1; background:#0b0d10;
    }
    #gate.show{ display:flex }
    #gate h1{ font-size:20px; margin:0 0 8px 0; color:#eaeef5 }
    #gate p{ margin:6px 0; color:#93a0b3 }
    header{
      position:fixed; left:8px; right:8px; top:calc(8px + var(--safe-top));
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      background:color-mix(in srgb, var(--panel) 88%, transparent);
      border:1px solid #1f2530;
      border-radius:14px; padding:10px 12px;
      box-shadow:var(--shadow);
      z-index:30;
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    }
    header .title{font-weight:700; letter-spacing:.2px; font-size:15px}
    header .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      border:1px solid #1f2530; background: #0e1217; color:var(--muted);
      border-radius:12px; padding:6px 10px; font-size:12px;
    }
    button{
      appearance:none; border:1px solid #1f2530; background:#10141a; color:var(--ink);
      padding:8px 12px; border-radius:10px; font-weight:600;
      box-shadow:var(--shadow); font-size:13px;
    }
    button.primary{ background:linear-gradient(180deg, #2a76ff, #195bdb); border-color:#1b4da8 }
    button.ghost{ background:#0e1217 }
    #hint{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      text-align:center; color:var(--muted);
      max-width:92vw; line-height:1.6; z-index:0; padding:0 8px;
    }
    #hint h1{font-size:22px; margin:0 0 8px 0; color:var(--ink)}
    #hint p{margin:0; font-size:14px}
    #badge{
      position:fixed; left:50%; bottom:calc(16px + var(--safe-bottom)); transform:translateX(-50%) translateY(120%);
      background:#0f1420; border:1px solid #1f2530; padding:10px 14px;
      border-radius:12px; font-weight:600; box-shadow:var(--shadow);
      z-index:25; opacity:.95; transition: transform .18s ease-out;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    }
    #badge.show{ transform:translateX(-50%) translateY(0) }
    #ruler{
      position:fixed; width:280px; height:92px;
      pointer-events:none; z-index:20;
      background: color-mix(in srgb, #0b111a 84%, transparent);
      border:1px solid #1f2530; border-radius:12px;
      box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center;
    }
    #ruler.hidden{ display:none }
    canvas{ width:256px; height:64px; image-rendering: pixelated; }
    /* nail handles */
    .handles{ position:absolute; inset:0; pointer-events:none }
    .handle{
      position:absolute; top:18px; width:20px; height:28px; border-radius:10px;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
      display:flex; align-items:center; justify-content:center;
      pointer-events:auto; touch-action:none;
    }
    .handle::after{
      content:''; width:4px; height:20px; background:#e5e7eb; border-radius:2px;
      box-shadow:0 0 0 1px rgba(0,0,0,.25) inset;
    }
    .tip{
      position:absolute; left:50%; top:4px; transform:translateX(-50%);
      font-size:11px; color:#d1d5db; opacity:.9;
      background:rgba(16,22,33,.65); padding:2px 8px; border-radius:999px; border:1px solid #1f2530;
      -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    }
    dialog{
      border:none; padding:0; border-radius:16px; width:min(92vw, 480px);
      color:var(--ink); background:#0e141d; border:1px solid #1e2633; box-shadow:var(--shadow);
    }
    dialog::backdrop{ background:rgba(3,5,8,.55); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px) }
    .dlg-head{ padding:14px 16px; font-weight:700; border-bottom:1px solid #1e2633 }
    .dlg-body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:8px; font-size:13px; color:var(--muted) }
    .row strong{ color:var(--ink) }
    .ctrl{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    input[type="range"]{ width:100% }
    .preview-card{
      width: 220px; height: 138.9px;
      border:2px dashed var(--accent); border-radius:10px; margin:8px auto; position:relative;
      display:flex; align-items:center; justify-content:center; color:var(--accent)
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    footer.tools{
      position:fixed; right:8px; bottom:calc(8px + var(--safe-bottom)); z-index:22; display:flex; gap:8px;
    }
    .pill{
      font-size:12px; color:#c9d3e1; border:1px solid #1f2530; padding:6px 10px; border-radius:1000px;
      background:#0e1217;
    }
    .note{ font-size:12px; color:var(--muted) }
    #a2hs{
      position:fixed; left:50%; bottom:calc(64px + var(--safe-bottom)); transform:translateX(-50%);
      background:#101827; color:#d1d5db; border:1px solid #1f2530; border-radius:12px; padding:10px 12px; font-size:13px;
      box-shadow:var(--shadow); display:none; z-index:12;
    }
    #a2hs.show{ display:block }
    /* mode toggle */
    .seg{
      display:flex; border:1px solid #1f2530; border-radius:10px; overflow:hidden;
    }
    .seg button{ border:0; background:#0e1217; color:#cbd5e1; padding:6px 10px; font-weight:600; }
    .seg button.active{ background:#1b2a3f; color:#eaeef5 }
  </style>
</head>
<body>
  <div id="gate">
    <div>
      <h1>仅支持手机端</h1>
      <p>请用 iPhone/Android 手机的浏览器打开（已针对 iOS Safari 优化）。</p>
      <p class="note">如需在桌面调试，请开启手机模拟与触摸事件。</p>
    </div>
  </div>
  <header>
    <div class="title">指甲宽度测量 · mm</div>
    <div class="right">
      <div class="chip" id="scaleInfo">校准系数 ×1.00</div>
      <div class="seg">
        <button id="modeNail" class="active">指甲模式</button>
        <button id="modeTouch">触点模式</button>
      </div>
      <button id="btnCalibrate" class="ghost">校准</button>
      <button id="btnRules" class="primary">尺码规则</button>
    </div>
  </header>

  <div id="hint">
    <h1>将手指轻压在屏幕上</h1>
    <p>指尖上方出现尺子。<b>指甲模式</b>下，拖动两侧白色把手，使其<strong>刚好贴齐指甲两侧</strong>，得到精确指甲宽度与推荐尺码。</p>
    <p class="note">先点右上角「校准」，用银行卡对齐虚线框（85.60 mm）。</p>
  </div>

  <div id="ruler" class="hidden">
    <div class="handles">
      <div class="tip">拖动白把手对齐指甲两侧</div>
      <div id="hLeft" class="handle" style="left:42px"></div>
      <div id="hRight" class="handle" style="left:190px"></div>
    </div>
    <canvas id="cv" width="256" height="64"></canvas>
  </div>
  <div id="badge">— mm • —</div>
  <div id="a2hs">提示：在 Safari 中点“分享”→“添加到主屏幕”，全屏使用更稳定。</div>

  <footer class="tools">
    <div class="pill" id="dbg">—</div>
  </footer>

  <!-- 尺码规则对话框（默认采用你提供的 S/M/L 拇指值 15/16/17 mm） -->
  <dialog id="dlgRules">
    <div class="dlg-head">尺码规则（默认按拇指指甲宽度）</div>
    <form method="dialog" class="dlg-body">
      <div class="row">
        <div>默认以<b>拇指指甲</b>宽度为准：S≈15mm，M≈16mm，L≈17mm。</div>
        <div class="grid">
          <label>S 目标（mm）<br/><input id="ruleS" type="number" step="0.1" min="10" max="30"></label>
          <label>M 目标（mm）<br/><input id="ruleM" type="number" step="0.1" min="10" max="30"></label>
        </div>
        <div class="row">边界按两档的中点计算：S/M 分界 = (S+M)/2，M/L 分界 = (M+L)/2。</div>
        <div class="note">如需完整五指表（S=15/11/12/11/9；M=16/12/13/12/10；L=17/13/14/13/11），可在说明中展示，但推荐尺码仍以拇指宽度为准。</div>
      </div>
      <div class="ctrl">
        <button value="cancel">取消</button>
        <button value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

  <!-- 校准对话框 -->
  <dialog id="dlgCal">
    <div class="dlg-head">毫米校准</div>
    <form method="dialog" class="dlg-body">
      <div class="row">
        <div>请把一张 <strong>标准银行卡/信用卡（宽 85.60 mm）</strong> 贴在屏幕上，对齐下方虚线框的宽度。</div>
        <div class="preview-card" id="cardBox">
          <div>对齐卡片宽度</div>
        </div>
        <div class="ctrl">
          <input id="scaleRange" type="range" min="0.80" max="1.20" step="0.001">
          <span id="scaleLabel">×1.00</span>
        </div>
        <div class="note">默认用 CSS 英寸换算；校准用于修正设备精度/玻璃曲率/系统缩放等误差。</div>
      </div>
      <div class="ctrl">
        <button value="reset">恢复默认</button>
        <button value="cancel">取消</button>
        <button value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const cv = $('#cv');
  const ctx = cv.getContext('2d', { alpha: true, desynchronized: true });
  const badge = $('#badge');
  const ruler = $('#ruler');
  const dbg = $('#dbg');
  const scaleInfo = $('#scaleInfo');
  const gate = $('#gate');
  const a2hs = $('#a2hs');
  const hLeft = $('#hLeft');
  const hRight = $('#hRight');
  const handlesBox = ruler.querySelector('.handles');
  const tipEl = ruler.querySelector('.tip');

  // 环境判定：仅移动触控
  const isMobileUA = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const hasTouch = navigator.maxTouchPoints > 0 || 'ontouchstart' in window;
  const isStandalone = window.navigator.standalone === true;
  if(!isMobileUA || !hasTouch){
    gate.classList.add('show');
  } else {
    const lastTip = parseInt(localStorage.getItem('a2hs_tip')||'0',10);
    const now = Date.now();
    if(!isStandalone && /Safari/i.test(navigator.userAgent) && !/CriOS|FxiOS|EdgiOS/i.test(navigator.userAgent)){
      if(now - lastTip > 3*24*3600*1000){
        a2hs.classList.add('show');
        setTimeout(()=>{ a2hs.classList.remove('show'); localStorage.setItem('a2hs_tip', String(Date.now())); }, 5000);
      }
    }
  }

  // 设置
  const st = {
    scale: parseFloat(localStorage.getItem('mm_scale') || '1'),
    // 默认规则（拇指 15/16/17）
    sTarget: parseFloat(localStorage.getItem('rule_s') || '15'),
    mTarget: parseFloat(localStorage.getItem('rule_m') || '16'),
    lTarget: 17
  };

  // 换算
  function cssPxPerInch(){
    const tmp = document.createElement('div');
    tmp.style.width = '1in';
    tmp.style.position='absolute'; tmp.style.left='-9999px'; tmp.style.top='-9999px';
    document.body.appendChild(tmp);
    const v = tmp.getBoundingClientRect().width;
    tmp.remove();
    return v;
  }
  let pxPerInch = cssPxPerInch();
  let pxPerMMBase = pxPerInch / 25.4;
  function pxPerMM(){ return pxPerMMBase * st.scale; }
  function mmFromPx(px){ return px / pxPerMM(); }
  function pxFromMM(mm){ return mm * pxPerMM(); }
  function setScaleLabel(){ scaleInfo.textContent = `校准系数 ×${st.scale.toFixed(2)}`; }
  setScaleLabel();

  // 尺子绘制
  function drawRuler(currentMM){
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#0e141d';
    ctx.fillRect(0,0,w,h);
    const originX = 10;
    const usableW = w - originX - 10;
    const ppm = pxPerMM();
    const totalMM = Math.floor(usableW/ppm);
    ctx.strokeStyle = '#2d3b51';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0;i<=totalMM;i++){
      const x = originX + i*ppm + 0.5;
      const len = (i%10===0) ? 18 : (i%5===0 ? 12 : 7);
      ctx.moveTo(x, 6); ctx.lineTo(x, 6+len);
    }
    ctx.stroke();
    // 标签
    ctx.fillStyle = '#c9d3e1';
    ctx.font = '11px -apple-system, system-ui, Segoe UI';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for(let i=0;i<=totalMM;i+=10){
      const x = originX + i*ppm;
      ctx.fillText(i.toString(), x, 26);
    }
    // 当前宽度线段
    const px = Math.max(0, Math.min(usableW, pxFromMM(currentMM)));
    ctx.strokeStyle = '#4aa3ff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(originX, 46);
    ctx.lineTo(originX + px, 46);
    ctx.stroke();
    // 端点
    ctx.strokeStyle = '#ff5a7a';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(originX, 38); ctx.lineTo(originX, 54);
    ctx.moveTo(originX + px, 38); ctx.lineTo(originX + px, 54);
    ctx.stroke();
  }

  // 推荐尺码：按目标值 S=15 M=16 L=17，边界取中点（15.5 / 16.5）
  function sizeFromNailWidth(mm){
    const sM = (st.sTarget + st.mTarget) / 2;
    const mL = (st.mTarget + st.lTarget) / 2;
    if(mm < sM) return 'S';
    if(mm < mL) return 'M';
    return 'L';
  }

  // 模式切换
  const btnNail = $('#modeNail');
  const btnTouch = $('#modeTouch');
  let mode = 'nail'; // 'nail' or 'touch'
  function setMode(m){
    mode = m;
    btnNail.classList.toggle('active', m==='nail');
    btnTouch.classList.toggle('active', m==='touch');
    handlesBox.style.display = (m==='nail') ? 'block' : 'none';
    tipEl.style.display = (m==='nail') ? 'block' : 'none';
  }
  btnNail.addEventListener('click', ()=>setMode('nail'));
  btnTouch.addEventListener('click', ()=>setMode('touch'));

  // 在手指位置弹出尺子
  function placeRuler(x, y){
    const rw = ruler.getBoundingClientRect().width;
    const rh = ruler.getBoundingClientRect().height;
    let left = Math.min(Math.max(8, x - rw/2), window.innerWidth - rw - 8);
    let top = Math.max(8 + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-top')||0), y - rh - 22);
    ruler.style.left = left + 'px';
    ruler.style.top = top + 'px';
    ruler.classList.remove('hidden');
  }

  // 触点模式（快速）
  let measuring = false;
  function updateTouchReading(x, y, widthPx){
    placeRuler(x, y);
    const mm = mmFromPx(widthPx);
    drawRuler(mm);
    badge.textContent = `${mm.toFixed(1)} mm • 尺码 ${sizeFromNailWidth(mm)}`;
    badge.classList.add('show');
    dbg.textContent = `触点:${widthPx.toFixed(1)}px → ${mm.toFixed(2)}mm | px/mm:${pxPerMM().toFixed(3)}`;
  }
  function onPointerDown(e){
    if(e.pointerType !== 'touch') return;
    measuring = true;
    placeRuler(e.clientX, e.clientY);
    if(mode==='touch' && e.width && e.width>0){
      updateTouchReading(e.clientX, e.clientY, e.width);
    }
  }
  function onPointerMove(e){
    if(!measuring || e.pointerType !== 'touch') return;
    if(mode==='touch' && e.width && e.width>0){
      updateTouchReading(e.clientX, e.clientY, e.width);
    }
  }
  function onPointerUp(e){
    if(e.pointerType !== 'touch') return;
    measuring = false;
  }

  // 指甲模式：拖动左右把手
  function updateFromHandles(){
    // 计算把手中心在 canvas 坐标系的位置，然后转 mm
    const cvBox = cv.getBoundingClientRect();
    const lBox = hLeft.getBoundingClientRect();
    const rBox = hRight.getBoundingClientRect();
    const lx = (lBox.left + lBox.width/2) - cvBox.left;
    const rx = (rBox.left + rBox.width/2) - cvBox.left;
    const originX = 10;
    const usableW = cv.width - originX - 10;
    const clamp = v=> Math.max(originX, Math.min(originX+usableW, v));
    const lxClamped = clamp(lx);
    const rxClamped = clamp(rx);
    const px = Math.abs(rxClamped - lxClamped);
    const mm = mmFromPx(px);
    drawRuler(mm);
    badge.textContent = `${mm.toFixed(1)} mm • 尺码 ${sizeFromNailWidth(mm)}`;
    badge.classList.add('show');
    dbg.textContent = `把手:${px.toFixed(1)}px → ${mm.toFixed(2)}mm | px/mm:${pxPerMM().toFixed(3)}`;
  }

  function makeDrag(el){
    let startX=0, startLeft=0;
    function onStart(ev){
      const t = (ev.touches && ev.touches[0]) || ev;
      startX = t.clientX;
      startLeft = parseFloat(getComputedStyle(el).left);
      document.addEventListener('touchmove', onMove, {passive:false});
      document.addEventListener('touchend', onEnd, {passive:true});
      document.addEventListener('pointermove', onMove, {passive:false});
      document.addEventListener('pointerup', onEnd, {passive:true});
      ev.preventDefault();
      ev.stopPropagation();
    }
    function onMove(ev){
      const t = (ev.touches && ev.touches[0]) || ev;
      const dx = t.clientX - startX;
      const box = ruler.getBoundingClientRect();
      let newLeft = Math.max(8, Math.min(box.width-28, startLeft + dx)); // padding+handle width
      el.style.left = newLeft + 'px';
      updateFromHandles();
      ev.preventDefault();
    }
    function onEnd(){
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onEnd);
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onEnd);
    }
    el.addEventListener('touchstart', onStart, {passive:false});
    el.addEventListener('pointerdown', onStart);
  }
  makeDrag(hLeft);
  makeDrag(hRight);

  // 初始把手间距 16mm
  function setInitialHandles(){
    const box = ruler.getBoundingClientRect();
    const cvBox = cv.getBoundingClientRect();
    const originX = cvBox.left + 10;
    const leftPX = originX + (cv.width - 20)/2 - pxFromMM(8);
    const rightPX = originX + (cv.width - 20)/2 + pxFromMM(8);
    hLeft.style.left = (leftPX - box.left - 10) + 'px';
    hRight.style.left = (rightPX - box.left - 10) + 'px';
    updateFromHandles();
  }

  // 事件绑定（移动端）
  if(!gate.classList.contains('show')){
    window.addEventListener('pointerdown', onPointerDown, {passive:true});
    window.addEventListener('pointermove', onPointerMove, {passive:true});
    window.addEventListener('pointerup', onPointerUp, {passive:true});

    window.addEventListener('touchstart', (e)=>{
      // 触碰用于放置尺子；随后可松开手指拖把手
      const t = e.touches[0];
      placeRuler(t.clientX, t.clientY);
      setInitialHandles();
    }, {passive:true});
  }

  // 对话框：规则
  const dlgRules = $('#dlgRules');
  $('#btnRules').addEventListener('click', () => {
    $('#ruleS').value = st.sTarget;
    $('#ruleM').value = st.mTarget;
    dlgRules.showModal();
  });
  dlgRules.addEventListener('close', () => {
    if(dlgRules.returnValue === 'ok'){
      const s = parseFloat($('#ruleS').value || '15');
      const m = parseFloat($('#ruleM').value || '16');
      st.sTarget = s; st.mTarget = m;
      localStorage.setItem('rule_s', s.toString());
      localStorage.setItem('rule_m', m.toString());
      updateFromHandles();
    }
  });

  // 校准
  const dlgCal = $('#dlgCal');
  $('#btnCalibrate').addEventListener('click', () => {
    $('#scaleRange').value = st.scale.toString();
    $('#scaleLabel').textContent = `×${(+st.scale).toFixed(2)}`;
    const cssPx = 85.6 * (pxPerMMBase * st.scale);
    const cardBox = $('#cardBox');
    cardBox.style.width = `${Math.max(120, Math.min(window.innerWidth - 64, cssPx))}px`;
    dlgCal.showModal();
  });
  $('#scaleRange').addEventListener('input', (e) => {
    const v = parseFloat(e.target.value);
    $('#scaleLabel').textContent = `×${v.toFixed(2)}`;
    const cardBox = $('#cardBox');
    const tmpPxPerMM = pxPerMMBase * v;
    const cssPx = 85.6 * tmpPxPerMM;
    cardBox.style.width = `${Math.max(120, Math.min(window.innerWidth - 64, cssPx))}px`;
  });
  dlgCal.addEventListener('close', () => {
    if(dlgCal.returnValue === 'ok'){
      const v = parseFloat($('#scaleRange').value);
      st.scale = v;
      localStorage.setItem('mm_scale', v.toString());
      setScaleLabel();
      updateFromHandles();
    }else if(dlgCal.returnValue === 'reset'){
      st.scale = 1;
      localStorage.removeItem('mm_scale');
      setScaleLabel();
      updateFromHandles();
    }
  });

  // 适配
  document.addEventListener('gesturestart', e => e.preventDefault());
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      pxPerInch = cssPxPerInch();
      pxPerMMBase = pxPerInch / 25.4;
      updateFromHandles();
    }, 250);
  }, { passive:true });

  // 初始画面
  drawRuler(0);
})();
</script>
</body>
</html>
