# Build a real-time update + center-0 aligned S-band fix
html = r"""<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no, email=no, address=no">
  <title>指甲宽度估算 · mm（手机端·Safari优化·中心零刻度·实时修复）</title>
  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12151a;
      --ink:#eaeef5;
      --muted:#93a0b3;
      --accent:#4aa3ff;
      --accent-2:#ff5a7a;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
      --s:#13261c; --m:#1f1f14; --l:#23161d;
      --sText:#8fe3be; --mText:#e8d089; --lText:#ffb2c1;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 70% -10%, #1c2330, #0b0d10 52%);
      overflow: hidden;
      -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
      touch-action: none;
    }
    #gate{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center;
      padding:24px; color:#cbd5e1; background:#0b0d10;
    }
    #gate.show{ display:flex }
    header{
      position:fixed; left:8px; right:8px; top:calc(8px + var(--safe-top));
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      background:color-mix(in srgb, var(--panel) 88%, transparent);
      border:1px solid #1f2530;
      border-radius:14px; padding:10px 12px;
      box-shadow:var(--shadow);
      z-index:30;
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    }
    header .title{font-weight:700; letter-spacing:.2px; font-size:15px}
    header .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      border:1px solid #1f2530; background: #0e1217; color:var(--muted);
      border-radius:12px; padding:6px 10px; font-size:12px;
    }
    button{
      appearance:none; border:1px solid #1f2530; background:#10141a; color:var(--ink);
      padding:8px 12px; border-radius:10px; font-weight:600;
      box-shadow:var(--shadow); font-size:13px;
    }
    button.primary{ background:linear-gradient(180deg, #2a76ff, #195bdb); border-color:#1b4da8 }
    button.ghost{ background:#0e1217 }
    #hint{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      text-align:center; color:var(--muted);
      max-width:92vw; line-height:1.6; z-index:0; padding:0 8px;
    }
    #hint h1{font-size:22px; margin:0 0 8px 0; color:var(--ink)}
    #hint p{margin:0; font-size:14px}
    #badge{
      position:fixed; left:50%; bottom:calc(16px + var(--safe-bottom)); transform:translateX(-50%) translateY(120%);
      background:#0f1420; border:1px solid #1f2530; padding:10px 14px;
      border-radius:12px; font-weight:600; box-shadow:var(--shadow);
      z-index:25; opacity:.95; transition: transform .18s ease-out;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    }
    #badge.show{ transform:translateX(-50%) translateY(0) }
    #ruler{
      position:fixed; width:310px; height:116px;
      pointer-events:none; z-index:20;
      background: color-mix(in srgb, #0b111a 84%, transparent);
      border:1px solid #1f2530; border-radius:12px;
      box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center;
    }
    #ruler.hidden{ display:none }
    canvas{ width:292px; height:86px; image-rendering: pixelated; }
    dialog{
      border:none; padding:0; border-radius:16px; width:min(92vw, 480px);
      color:var(--ink); background:#0e141d; border:1px solid #1e2633; box-shadow:var(--shadow);
    }
    dialog::backdrop{ background:rgba(3,5,8,.55); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px) }
    .dlg-head{ padding:14px 16px; font-weight:700; border-bottom:1px solid #1e2633 }
    .dlg-body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:8px; font-size:13px; color:var(--muted) }
    .row strong{ color:var(--ink) }
    .ctrl{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    input[type="range"]{ width:100% }
    .preview-card{
      width: 220px; height: 138.9px;
      border:2px dashed var(--accent); border-radius:10px; margin:8px auto; position:relative;
      display:flex; align-items:center; justify-content:center; color:var(--accent)
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  </style>
</head>
<body>
  <div id="gate"><div>仅支持手机端</div></div>
  <header>
    <div class="title">指甲宽度估算 · mm</div>
    <div class="right">
      <div class="chip" id="scaleInfo">校准×0.83｜比例×0.68</div>
      <button id="btnCalibrate" class="ghost">校准</button>
      <button id="btnRatio" class="ghost">指甲比例</button>
      <button id="btnRules" class="primary">尺码规则</button>
    </div>
  </header>

  <div id="hint">
    <h1>将指尖轻压在屏幕上</h1>
    <p>读取接触宽度，按照 <b>指甲 = 手指 × 比例</b> 估算（比例默认 0.68，可调）。</p>
    <p>尺子采用<b>中心零刻度</b>与 <b>L | M | S | M | L</b> 视觉布局：S 区域居中，零点在 S 正上方，两侧以 5、10、15… 递增。</p>
    <p class="note">默认<b>校准</b>为 <b>0.83</b>（你反馈更准），不同设备仍可手动微调。</p>
  </div>

  <div id="ruler" class="hidden"><canvas id="cv" width="292" height="86"></canvas></div>
  <div id="badge">— mm • —</div>

  <!-- 尺码规则 -->
  <dialog id="dlgRules">
    <div class="dlg-head">尺码规则（拇指）</div>
    <form method="dialog" class="dlg-body">
      <div class="row">
        <div>默认：S≈15mm，M≈16mm，L≈17mm；边界取中点（15.5 / 16.5）。</div>
        <div class="grid">
          <label>S 目标（mm）<br/><input id="ruleS" type="number" step="0.1" min="10" max="30"></label>
          <label>M 目标（mm）<br/><input id="ruleM" type="number" step="0.1" min="10" max="30"></label>
        </div>
      </div>
      <div class="ctrl">
        <button value="cancel">取消</button>
        <button value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

  <!-- 校准 -->
  <dialog id="dlgCal">
    <div class="dlg-head">毫米校准</div>
    <form method="dialog" class="dlg-body">
      <div class="row">
        <div>将 <strong>银行卡（宽 85.60 mm）</strong> 贴在屏幕上，对齐下方虚线框。</div>
        <div class="preview-card" id="cardBox"><div>对齐卡片宽度</div></div>
        <div class="ctrl">
          <input id="scaleRange" type="range" min="0.70" max="1.20" step="0.001">
          <span id="scaleLabel">×0.83</span>
        </div>
      </div>
      <div class="ctrl">
        <button value="reset">恢复默认</button>
        <button value="cancel">取消</button>
        <button value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

  <!-- 比例 -->
  <dialog id="dlgRatio">
    <div class="dlg-head">指甲占手指比例</div>
    <form method="dialog" class="dlg-body">
      <div class="row">
        <div>估算公式：<strong>指甲宽 ≈ 手指接触宽 × 比例</strong></div>
        <div class="ctrl">
          <input id="ratioRange" type="range" min="0.50" max="0.90" step="0.01">
          <span id="ratioLabel">×0.68</span>
        </div>
      </div>
      <div class="ctrl">
        <button value="cancel">取消</button>
        <button value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const cv = $('#cv');
  const ctx = cv.getContext('2d', { alpha: true, desynchronized: true });
  const badge = $('#badge');
  const ruler = $('#ruler');
  const scaleInfo = $('#scaleInfo');

  // 仅移动端
  const isMobileUA = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const hasTouch = navigator.maxTouchPoints > 0 || 'ontouchstart' in window;
  if(!isMobileUA || !hasTouch){ $('#gate').classList.add('show'); }

  // 默认设置：校准 0.83，比例 0.68
  const st = {
    scale: parseFloat(localStorage.getItem('mm_scale') || '0.83'),
    ratio: parseFloat(localStorage.getItem('nail_ratio') || '0.68'),
    sTarget: parseFloat(localStorage.getItem('rule_s') || '15'),
    mTarget: parseFloat(localStorage.getItem('rule_m') || '16'),
    lTarget: 17
  };
  function updateChip(){ scaleInfo.textContent = `校准×${st.scale.toFixed(2)}｜比例×${st.ratio.toFixed(2)}`; }
  updateChip();

  function cssPxPerInch(){
    const tmp = document.createElement('div');
    tmp.style.width = '1in';
    tmp.style.position='absolute'; tmp.style.left='-9999px'; tmp.style.top='-9999px';
    document.body.appendChild(tmp);
    const v = tmp.getBoundingClientRect().width;
    tmp.remove();
    return v;
  }
  let pxPerInch = cssPxPerInch();
  let pxPerMMBase = pxPerInch / 25.4;
  function pxPerMM(){ return pxPerMMBase * st.scale; }
  function mmFromPx(px){ return px / pxPerMM(); }
  function pxFromMM(mm){ return mm * pxPerMM(); }

  // 画尺子：S 带中心 = 零刻度
  function drawRuler(nailMM){
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#0e141d';
    ctx.fillRect(0,0,w,h);

    const originX = 10;
    const usableW = w - originX - 10;
    const ppm = pxPerMM();

    // 分界与中心（单位：mm）
    const sM = (st.sTarget + st.mTarget) / 2; // 15.5
    const mL = (st.mTarget + st.lTarget) / 2; // 16.5
    const centerMM = (sM + mL) / 2;           // 16.0
    const centerX = originX + centerMM * ppm;

    // 带区域：左(M/L)，中(S)，右(M/L)
    const bandTop = 30, bandH = 26;
    function xOf(mm){ return originX + Math.max(0, Math.min(usableW, mm * ppm)); }
    ctx.fillStyle = '#23161d'; ctx.fillRect(originX, bandTop, xOf(sM)-originX, bandH);
    ctx.fillStyle = '#13261c'; ctx.fillRect(xOf(sM), bandTop, xOf(mL)-xOf(sM), bandH);
    ctx.fillStyle = '#23161d'; ctx.fillRect(xOf(mL), bandTop, originX+usableW-xOf(mL), bandH);

    // 分隔线
    ctx.strokeStyle = '#3a475b'; ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(xOf(sM)+0.5, bandTop-12); ctx.lineTo(xOf(sM)+0.5, bandTop+bandH+12);
    ctx.moveTo(xOf(mL)+0.5, bandTop-12); ctx.lineTo(xOf(mL)+0.5, bandTop+bandH+12);
    ctx.stroke();

    // 标签位置与实际边界对齐：S 放在 sM~mL 中心；左右 M/L 按区间中点放置
    ctx.font = 'bold 12px -apple-system, system-ui, Segoe UI';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillStyle = '#8fe3be'; ctx.fillText('S', (xOf(sM)+xOf(mL))/2, bandTop+bandH/2);
    ctx.fillStyle = '#e8d089'; ctx.fillText('M', (originX+xOf(sM))/2, bandTop+bandH/2);
    ctx.fillStyle = '#e8d089'; ctx.fillText('M', (xOf(mL)+originX+usableW)/2, bandTop+bandH/2);
    ctx.fillStyle = '#ffb2c1'; ctx.fillText('L', originX+12, bandTop+bandH/2);
    ctx.fillStyle = '#ffb2c1'; ctx.fillText('L', originX+usableW-12, bandTop+bandH/2);

    // 顶部：中心零刻度 + 对称 5mm 递增（数字与刻度）
    const leftEdge = originX, rightEdge = originX + usableW;
    ctx.strokeStyle = '#2d3b51'; ctx.lineWidth = 1;
    const stepPx = pxFromMM(5);
    const maxSteps = Math.ceil((Math.max(centerX-leftEdge, rightEdge-centerX)) / stepPx) + 1;
    ctx.beginPath();
    for(let i=-maxSteps; i<=maxSteps; i++){
      const x = centerX + i*stepPx + 0.5;
      if(x < leftEdge || x > rightEdge) continue;
      const len = (i%2===0) ? 10 : 6; // 每10mm更长
      ctx.moveTo(x, bandTop-4); ctx.lineTo(x, bandTop-4-len);
    }
    ctx.stroke();
    ctx.fillStyle = '#c9d3e1';
    ctx.font = '10px -apple-system, system-ui, Segoe UI';
    ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    ctx.fillText('0', centerX, bandTop-6);
    for(let mm=5; mm<=50; mm+=5){
      const xR = centerX + pxFromMM(mm);
      const xL = centerX - pxFromMM(mm);
      if(xR>=leftEdge && xR<=rightEdge) ctx.fillText(String(mm), xR, bandTop-6);
      if(xL>=leftEdge && xL<=rightEdge) ctx.fillText(String(mm), xL, bandTop-6);
    }

    // 当前值指示（从 0mm 开始到 nailMM 的绝对长度）
    const px = Math.max(0, Math.min(usableW, pxFromMM(nailMM)));
    ctx.strokeStyle = '#4aa3ff'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(originX, bandTop+bandH+14);
    ctx.lineTo(originX + px, bandTop+bandH+14);
    ctx.stroke();
    ctx.strokeStyle = '#ff5a7a';
    ctx.beginPath();
    ctx.moveTo(originX, bandTop+bandH+6); ctx.lineTo(originX, bandTop+bandH+22);
    ctx.moveTo(originX + px, bandTop+bandH+6); ctx.lineTo(originX + px, bandTop+bandH+22);
    ctx.stroke();
  }

  function sizeFromNailWidth(mm){
    const sM = (st.sTarget + st.mTarget) / 2;
    const mL = (st.mTarget + st.lTarget) / 2;
    if(mm < sM) return 'S';
    if(mm < mL) return 'M';
    return 'L';
  }

  function placeRuler(x, y){
    const rw = ruler.getBoundingClientRect().width;
    const rh = ruler.getBoundingClientRect().height;
    let left = Math.min(Math.max(8, x - rw/2), window.innerWidth - rw - 8);
    let top = Math.max(8 + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-top')||0), y - rh - 24);
    ruler.style.left = left + 'px';
    ruler.style.top = top + 'px';
    ruler.classList.remove('hidden');
  }

  // —— 实时更新（rAF + 事件喂数） ——
  let measuring = false, hasSample=false;
  let lastX=0, lastY=0, lastW=0;
  function feedSample(x,y,w){
    lastX=x; lastY=y; lastW=w; hasSample=true;
    placeRuler(x,y);
  }
  function loop(){
    if(measuring && hasSample){
      const fingerMM = mmFromPx(lastW);
      const nailMM = fingerMM * st.ratio;
      drawRuler(nailMM);
      badge.textContent = `估算指甲 ${nailMM.toFixed(1)} mm • 尺码 ${sizeFromNailWidth(nailMM)}`;
      badge.classList.add('show');
      hasSample=false; // 等待下一帧新样本
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Pointer / Touch 事件：不断喂样本，动画循环实时渲染
  function onPointerDown(e){
    if(e.pointerType !== 'touch') return;
    measuring = true;
    if(e.width && e.width>0) feedSample(e.clientX, e.clientY, e.width);
  }
  function onPointerMove(e){
    if(!measuring || e.pointerType !== 'touch') return;
    if(e.width && e.width>0) feedSample(e.clientX, e.clientY, e.width);
  }
  function onPointerUp(e){ if(e.pointerType==='touch') measuring=false; }
  window.addEventListener('pointerdown', onPointerDown, {passive:true});
  window.addEventListener('pointermove', onPointerMove, {passive:true});
  window.addEventListener('pointerup', onPointerUp, {passive:true});

  function onTouch(e){
    if(e.touches.length===0) return;
    const t = e.touches[0];
    const widthPx = t.radiusX ? (t.radiusX * 2) : 0;
    if(widthPx>0) feedSample(t.clientX, t.clientY, widthPx);
  }
  window.addEventListener('touchstart', onTouch, {passive:true});
  window.addEventListener('touchmove', onTouch, {passive:true});

  // 校准
  const dlgCal = $('#dlgCal');
  $('#btnCalibrate').addEventListener('click', () => {
    $('#scaleRange').value = st.scale.toString();
    $('#scaleLabel').textContent = `×${st.scale.toFixed(2)}`;
    const tmpPxPerMM = (cssPxPerInch()/25.4) * st.scale;
    const cssPx = 85.6 * tmpPxPerMM;
    $('#cardBox').style.width = `${Math.max(120, Math.min(window.innerWidth - 64, cssPx))}px`;
    dlgCal.showModal();
  });
  $('#scaleRange').addEventListener('input', (e) => {
    const v = parseFloat(e.target.value);
    $('#scaleLabel').textContent = `×${v.toFixed(2)}`;
    const tmpPxPerMM = (cssPxPerInch()/25.4) * v;
    const cssPx = 85.6 * tmpPxPerMM;
    $('#cardBox').style.width = `${Math.max(120, Math.min(window.innerWidth - 64, cssPx))}px`;
  });
  dlgCal.addEventListener('close', () => {
    if(dlgCal.returnValue === 'ok'){
      st.scale = parseFloat($('#scaleRange').value);
      localStorage.setItem('mm_scale', String(st.scale));
      updateChip();
    }else if(dlgCal.returnValue === 'reset'){
      st.scale = 0.83;
      localStorage.setItem('mm_scale', String(st.scale));
      updateChip();
    }
  });

  // 比例
  const dlgRatio = $('#dlgRatio');
  $('#btnRatio').addEventListener('click', () => {
    $('#ratioRange').value = st.ratio.toString();
    $('#ratioLabel').textContent = `×${st.ratio.toFixed(2)}`;
    dlgRatio.showModal();
  });
  $('#ratioRange'].addEventListener('input', (e) => {
    const v = parseFloat(e.target.value);
    $('#ratioLabel').textContent = `×${v.toFixed(2)}`;
  });
  dlgRatio.addEventListener('close', () => {
    if(dlgRatio.returnValue === 'ok'){
      st.ratio = parseFloat($('#ratioRange').value);
      localStorage.setItem('nail_ratio', String(st.ratio));
      updateChip();
    }
  });

  // 规则
  const dlgRules = $('#dlgRules');
  $('#btnRules').addEventListener('click', () => {
    $('#ruleS').value = st.sTarget;
    $('#ruleM').value = st.mTarget;
    dlgRules.showModal();
  });
  dlgRules.addEventListener('close', () => {
    if(dlgRules.returnValue === 'ok'){
      st.sTarget = parseFloat($('#ruleS').value || '15');
      st.mTarget = parseFloat($('#ruleM').value || '16');
      localStorage.setItem('rule_s', String(st.sTarget));
      localStorage.setItem('rule_m', String(st.mTarget));
    }
  });

  document.addEventListener('gesturestart', e => e.preventDefault());
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      pxPerInch = cssPxPerInch();
      pxPerMMBase = pxPerInch / 25.4;
    }, 250);
  }, { passive:true });

  drawRuler(16);
})();
</script>
</body>
</html>
"""
path = "/mnt/data/finger-ruler-nailratio-centered-scale083-rtfix.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)

path
